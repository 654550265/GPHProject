/*
 * register
 * 2016-4-6
 * sunxiaowen
 * */
(function($,pubFuc){
	var url=pubFuc.url(),
	      urls=pubFuc.urls();
	
	var api={
		  "registerUrl":url+"/user/mall/register",
		  "messageUrlSaas":url+"/sms/saas/verify",
		  "messageUrlMall":url+"/sms/register/verify",
		  "registerApi":url+"/user",
		  "regChannel":url+'/dealerBusinessLicense/regChannel'
	};
	
	var dom={
          "J_next":".J_next",
          "J_error":".J_error",
          "J_mobile":".J_mobile",
          "J_reloadCode":".J_reloadCode",
          "J_imgCode":".J_imgCode",
          "J_getMessCode":".J_getMessCode",
          "J_code":".J_code",
          "J_verifyCode":".J_verifyCode",
          "J_password":".J_password",
          "J_newPassword":".J_newPassword",          
          "J_showAgreen":".J_showAgreen",
          "J_agreenBox":".J_agreenBox",
          "J_sourceType":".J_sourceType",
          "J_channel":".J_channel",
          "J_dealerName":".J_dealerName",
          "J_linkman":".J_linkman",
          "J_type":".J_type",
          "J_typeImg":".J_typeImg",
          "J_step":".J_step"
	};
	
	var register=(function(){
		return{
			init:function(){
                this.nextRegister();
                this.setDefault();
                this.showAgreen();
                this.regChannel();
                this.checkedType();
                /*this.getflag();*/
			},
			
			checkedType:function(){
				$(dom.J_type).on('click',function(){
					var index=$(dom.J_type).index(this);
					$(this).addClass('on').siblings(dom.J_type).removeClass('on');
					$(dom.J_typeImg).find("img").eq(index).show().siblings().hide();
					$(dom.J_step).eq(index).show().siblings(dom.J_step).hide();
					$(dom.J_next).attr('attr-type',index);
					/* 工厂/企业注册 */
					if(index==0){
						$(dom.J_linkman).parent().hide();
						$(dom.J_dealerName).parent().show();
						$(dom.J_code).attr('attr-type','mall');
					}
					/* 分销/贸易商注册 */
					if(index==1){
						$(dom.J_linkman).parent().show();
						$(dom.J_dealerName).parent().show();
						$(dom.J_code).attr('attr-type','saas');
					}
					/* 个人注册 */
					if(index==2){
						$(dom.J_linkman).parent().hide();
						$(dom.J_dealerName).parent().hide();
						$(dom.J_code).attr('attr-type','mall');
					}
				});
			},
			
			setDefault:function(){
				var _this_=this;
				
				$(dom.J_getMessCode).removeAttr("disabled");
				$(dom.J_reloadCode+","+dom.J_imgCode).on("click",function(){
					_this_.reloadCode();
				});
				
				$(dom.J_getMessCode).on("click",function(){
					_this_.getMessage();
				});
				
				$(dom.J_mobile).on("blur keyup",function(){
					_this_.checkMobile();
				});
				
				$(dom.J_code).on("blur keyup",function(){
					_this_.checkvCode();
				});	
				
				$(dom.J_verifyCode).on("blur keyup",function(){
					_this_.checkvVerifyCode();
				});			
				
				$(dom.J_password).on("blur keyup",function(){
					_this_.checkPassword();
				});
				
				$(dom.J_newPassword).on("blur keyup",function(){
					_this_.checkNewPassword();
				});
				
				$(dom.J_dealerName).on("blur keyup",function(){
					_this_.checkDealerName();
				});
				
				$(dom.J_linkman).on("blur keyup",function(){
					_this_.checkLinkman();
				});				
			},
			
			/*getflag:function(){
				var flag=pubFuc.getStr("flag");
				if(flag){
					pubFuc.cookie({
						"cookieName":"flag",
						"cookieValue":flag,
					});
				}
			},*/
			
			checkType:function(){				
				var type = false;
				$.each($(dom.J_type),function(i,v){
					if($(this).attr('class').indexOf('on')>=0){
						type = true;
					}
				});
				if(!type){
					$(dom.J_type).eq(0).parent().append('<label class="error J_error">客户性质不能为空</label>');
					return false;
				}
				return true;
			},
			
			regChannel:function(){
				var sourceType=$(dom.J_sourceType).val();
				if(sourceType){
					$(dom.J_channel).show();
				}
			},
			
			checkMobile:function(){
				var mobile=$(dom.J_mobile).val();
				$(dom.J_error).remove();
				if(!mobile){
					$(dom.J_mobile).after('<label class="error J_error">手机号码不能为空</label>');
					return false;
				}if(!pubFuc.checkTel(mobile)){
					$(dom.J_mobile).after('<label class="error J_error">手机号码格式不正确</label>');
					return false;
				}else{
					return true;
				}
			},
			
			checkvCode:function(){
				var code=$(dom.J_code).val();
				$(dom.J_error).remove();
				if(!code){
					$(dom.J_code).parent().append('<label class="error J_error">验证码不能为空</label>');
					return false;
				}else{
					return true;
				}
			},			
			
			checkvVerifyCode:function(){
				var verifyCode=$(dom.J_verifyCode).val();
				$(dom.J_error).remove();
				if(!verifyCode){
					$(dom.J_verifyCode).parent().append('<label class="error J_error">短信验证码不能为空</label>');
					return false;
				}else{
					return true;
				}
			},
			
			checkDealerName:function(){
				var dealerName=$(dom.J_dealerName).val();
				$(dom.J_error).remove();
				if(!dealerName){
					$(dom.J_dealerName).parent().append('<label class="error J_error">公司名称不能为空</label>');
					return false;
				}else{
					return true;
				}
			},
			
			checkLinkman:function(){
				var linkman=$(dom.J_linkman).val();
				$(dom.J_error).remove();
				if(!linkman){
					$(dom.J_linkman).parent().append('<label class="error J_error">联系人不能为空</label>');
					return false;
				}else{
					return true;
				}
			},
			
			checkPassword:function(){
				var password=$(dom.J_password).val();
				$(dom.J_error).remove();
				if(!password){
					$(dom.J_password).parent().append('<label class="error J_error">密码不能为空</label>');
					return false;
				}
				if(!pubFuc.checkPsw(password)){
					$(dom.J_password).parent().append('<label class="error J_error">密码由数字、字母（区分大小写）和特殊字符（空格除外）至少两类组合组成，长度8~16位</label>');
					return false;
				}
				return true;
			},
			
			checkNewPassword:function(){
				var newPassword=$(dom.J_newPassword).val(),
				      password=$(dom.J_password).val();
				$(dom.J_error).remove();
				if(!newPassword){
					$(dom.J_newPassword).parent().append('<label class="error J_error">确认密码不能为空</label>');
					return false;
				}
				if(!pubFuc.checkPsw(newPassword)){
					$(dom.J_newPassword).parent().append('<label class="error J_error">密码由数字、字母（区分大小写）和特殊字符至少两类组合组成，长度8~16位</label>');
					return false;
				}
				if(password!=newPassword){
					$(dom.J_newPassword).parent().append('<label class="error J_error">2次输入密码不同</label>');
					return false;
				}
				return true;
			},
			
			getMessage:function(){
        		var _this_=this,
        		      mobile=$(dom.J_mobile).val(),
        		      vCode=$(dom.J_code).val(),
        		      type=$(dom.J_code).attr('attr-type'),
        		      codeUrl,
        		      data={};
        		if(!_this_.checkMobile()){
        			return;
        		}
        		if(!_this_.checkvCode()){
        			return;
        		}
        		$(dom.J_getMessCode).addClass("on").prop("disabled","disabled").val("60秒后重新发送");
        		var tp=_this_.sendCodeSuc();
    		    data.vcode=vCode;
    		    data.mobile=mobile;
    		    if(type=='mall'){
    		    	codeUrl=api.messageUrlMall;
    		    }else{
    		    	codeUrl=api.messageUrlSaas;
    		    }
        		pubFuc.load(codeUrl,data,"GET",function(s){
        			if(s.code==0){
        				_this_.reloadCode();
        			}else{
        				$(dom.J_getMessCode).after('<label class="error J_error">'+s.msg+'</label>');
        				$(dom.J_getMessCode).removeClass("on").removeAttr("disabled").val("获取短信验证码");
        				_this_.reloadCode();
        				clearInterval(tp);
        			}
        		},function(e){
        			console.log(e);
        		});
        	},
        	
        	sendCodeSuc:function(){
    			var times=60;
    			var m=setInterval(function(){
    				times--;
    				if(times==0){
    					$(dom.J_getMessCode).removeClass("on").prop("disabled","").val("重新发送");
    					clearInterval(m);
    				}else{
    					$(dom.J_getMessCode).addClass("on").prop("disabled","disabled").val(times+"秒后重新发送");
    				}
    				
    			},1000);
    			return m;
    		},
			
			reloadCode:function(){
        		var date = new Date();
        		$(dom.J_imgCode).attr("src",urls+ "/page/loginCaptcha.jsp?id=" + date.getMilliseconds());         			
        	},
			
			nextRegister:function(){
				var _this_=this;
				$(dom.J_next).on("click",function(){
					var agreenBox=$(dom.J_agreenBox).prop("checked"),
					      _ab_=$(this),
					      type=_ab_.attr("attr-type"),
					      mobile=$(dom.J_mobile).val(),
					      verifyCode=$(dom.J_verifyCode).val(),
					      dealerName=$(dom.J_dealerName).val(),
					      linkman=$(dom.J_linkman).val(),
					      password=$(dom.J_password).val(),
					      sourceType=$(dom.J_sourceType).val(),
                          data={};
					if(!agreenBox){
					    pubFuc.openWindow("请认真阅读并同意《工品汇用户服务条款》",320,120);
					    return;
				    }
					if(!_this_.checkType()){
					    return;
				    }
					if(!_this_.checkMobile()){
					    return;
				    }
					if(!_this_.checkvCode()){
						 return;
					}
					if(!_this_.checkvVerifyCode()){
					    return;
				    }					   
				    if(!_this_.checkPassword()){
					    return;
				    }
				    if(!_this_.checkNewPassword()){
					    return;
				    }
//				    if(type=="0"){
//				    	 if(!_this_.checkDealerName()){
//							    return;
//						 }
//				    }
					if(type=="1"){
					    if(!_this_.checkDealerName()){
						    return;
					    }
					    if(!_this_.checkLinkman()){
						    return;
					    }
						$(this).addClass("next-wait").attr("attr-type",2);						
						data.mobile=mobile;
						data.verifyCode=verifyCode;
						data.dealerName=dealerName;
						data.linkman=linkman;
						data.password=password;
						data.regChannel=1;
						if(sourceType){
							data.sourceType=sourceType;
						}
						pubFuc.load(api.registerApi,data,"POST",function(s){
							if(s.code==0){
								location.href=urls+"/register/authen";
							}else{
								pubFuc.openWindow(s.msg+"，请重新注册或者联系客服",320,120);
								_ab_.removeClass("next-wait").attr("attr-type",1);
							}
						},function(e){
							pubFuc.openWindow("程序异常，请联系客服",320,120);
						});	
					}else{
						var typeXz;
						data.userName=mobile;
	  			        data.verifyCode=verifyCode;
	  			        data.password=password;
						$.each($(dom.J_type),function(i,v){
							if($(this).attr('class').indexOf('on')>=0){
								typeXz=$(this).attr('attr-type');
							}
						});
						data.dealerType=typeXz;
						if(type=="0"){
							if(!_this_.checkDealerName()){
							    return;
							}
							data.dealerName=dealerName;
						}
						if(sourceType){
							data.sourceType=sourceType;
						}
//						console.log(data);
//						return;
						pubFuc.load(api.registerUrl,data,"POST",function(s){
	  				        if(s.code==0){
	  				        	location.href=urls+"/register/true?type="+type;
	  				        }else{
	  				        	pubFuc.openWindow(s.msg,300,120);
	  				        }
	  			        },function(e){
	  				        console.log(e);
	  			        });	
					}
				});
			},
			
            showAgreen:function(){
			    $(dom.J_showAgreen).on("click",function(){
			    	var mHtml=
			    		'<div class="agreenment-title ft16">工品汇用户服务条款</div>'+
			    		'<div class="agreenment">'+			    		
			    		'<span class="ft14 weight">第一章 概述</span>'+
			    		'<p>第一条 为促进开放、透明、分享、责任的新商业文明，保障工品汇网站用户的合法权益，创建、维护和谐的网络商业环境，制订本规则。</p>'+
			    		'<p>第二条 本规则适用于使用工品汇网站任何产品或服务（以下统称“服务”）的用户。 </p>'+
			    		'<p>第三条 用户在适用规则上一律平等。</p>'+
			    		'<p>第四条 用户应遵守国家法律、行政法规、部门规章等规范性文件以及与工品汇签署的协议、工品汇服务条款、网站规则。</p>'+
			    		'<p>第五条 若本规则的规定同用户与工品汇签署的协议的约定相冲突，则优先适用双方协议的约定。协议中未约定的，则适用本规则。本规则尚无规定的，工品汇有权酌情处理，但工品汇对用户的处理不能免除用户应尽的法律责任。</p>'+
			    		'<p>第六条 工品汇有权视需要对本规则做修订，对本规则的修订在工品汇网站上公告后生效。 </p>'+
			    		'<span class="ft14 weight">第二章 定义</span>'+
			    		'<p>第七条 工品汇：指工品汇网站，所涉域名为：www.vipmro.net。</p>'+
			    		'<p>第八条 用户：指工品汇各项服务的使用者。</p>'+
			    		'<p>第九条 会员：指与工品汇签订《工品汇服务条款》 并完成注册流程的用户。每个帐号对应唯一的会员名。 </p>'+
			    		'<p>第十条 零售商：指在工品汇上浏览或购买产品或发布询价单的用户。</p>'+
			    		'<p>第十一条 供应商：指在工品汇上发布供应产品信息、企业信息或发布报价单的会员。</p>'+
			    		'<p>第十二条 投诉方：指发起投诉的符合相关法律规定的自然人、法人、其他经济组织。</p>'+
			    		'<p>第十三条 被投诉方：指投诉方所投诉的工品汇网站用户。</p>'+
			    		'<p>第十四条 反通知：被投诉方接到投诉方的投诉通知后向工品汇提交的通知及相关证明材料。</p>'+
			    		'<p>第十五条 处罚：指用户因自身违规行为而被处理，具体种类包括：警告、下架、删除、降权、帐号限权、帐号关闭等。  </p>'+
			    		'<p>警告：指工品汇通过电话、短信、邮件等形式提醒、告诫用户其行为已经构成了违规，应当及时予以改正，如仍进行或不停止违规行为，将给予更为严厉的处理。 </p>'+
			    		'<p>下架：指工品汇针对违规信息将进行信息下架，信息下架后用户仍可进行修改，修改正确后，信息方可正常发布。 </p>'+
			    		'<p>删除：指工品汇针对违规信息做删除的处理，信息删除后用户不可修改。 </p>'+
			    		'<p>降权：指用户发布的产品信息排序被置后。 </p>'+
			    		'<p>帐号限权：指工品汇暂停用户包括但不限于以下权限：暂停用户的访问权限、对已发布的所有信息执行下架或删除处理（如有）、暂停供应产品信息或采购单、报价单的操作权限等。</p>'+
			    		'<p>被限权用户在限权期限内服务费用（包括但不限于保证金、服务费等，如有）照常计算，服务期限不予延长。 </p>'+
			    		'<p>帐号关闭：工品汇终止向用户提供任何服务，并不予退返服务费（如有）。  </p>'+
			    		'<span class="ft14 weight">第三章 用户行为规则</span>'+
			    		'<p>第一节 注册</p>'+
			    		'<p>帐号注册</p>'+
			    		'<p>第十六条  用户在工品汇注册帐号时需同意并遵守《工品汇服务条款》； 用户会员名（ID，也称会员帐号或帐号）中不得包含违反国家法律法规、涉嫌侵犯他人权利或干扰工品汇正常运营秩序等的相关信息；</p>'+
			    		'<p>同一个会员名只能注册一个帐号，并且验证该帐号有效的手机号或邮箱未用于其它帐号的验证，会员名注册后无法自行修改 （工品汇审核同意的除外）。</p>'+
			    		'<p>第十七条  用户注册后必须提供公司营业执照、税务登记证、组织机构代码证并进行法人资格认证后才能使用工品汇网站提供的服务。</p>'+
			    		'<p>帐号管理</p>'+
			    		'<p>第十八条 禁止会员帐号未经工品汇审核同意随意转让他人或其他企业使用；随意转让会员帐号的将被关闭，且转让方还须承担该帐号下所有行为的法律责任。 </p>'+
			    		'<p>第十九条  工品汇有权回收未通过身份认证或虽通过身份认证但连续超过一年未登录的会员帐号；</p>'+
			    		'<p>工品汇有权关闭涉嫌欺诈等重度违规行为的会员帐号，并有权删除该帐号下所有相关信息；会员可通过工品汇网站客服主动申请关闭其帐号。</p>'+
			    		'<p>第二节 经营</p>'+
			    		'<p>信息发布/管理</p>'+
			    		'<p>第二十条 用户在工品汇网站发布信息应遵循合法、真实、准确、有效、完整的基本原则 ，对自己发布的信息独立承担全部责任； 不得包含违反国家法律法规、涉嫌侵犯他人合法权益或干扰工品汇网站运营秩序等相关内容。</p>'+
			    		'<p>支付</p>'+
			    		'<p>第二十一条  当交易双方选择并确认使用工品汇支付服务后，将视为接受由工品汇提供的各类支付服务，并遵守工品汇有关规定。</p>'+
			    		'<p>发货</p>'+
			    		'<p>第二十二条  供应商在零售商支付订单之后的5天内必须发货，否则订单取消，退款给零售商。</p>'+
			    		'<p>收货</p>'+
			    		'<p>第二十三条  零售商在供应商发货后的15天内必须选择确认收货或退货，否则默认交易成功，打款给供应商。</p>'+
			    		'<p>退货退款</p>'+
			    		'<p>第二十四条 零售商在订单支付之前可以取消订单，一旦支付，订单不可取消。</p>'+
			    		'<p>第二十五条 零售商在确认收货之前可以申请退货退款，退货必须征得供应商同意。</p>'+
			    		'<p>第二十六条 零售商申请退货退款后，依以下情况分别处理：</p>'+
			    		'<p>（一）自零售商申请退货退款之时起7天内供应商未做处理的，工品汇视为供应商同意零售商的退货退款申请，并退款给零售商。</p>'+
			    		'<p>（二）供应商拒绝退款申请后，零售商不能再次修改退款申请，交易正常进行，工品汇将打款给供应商。</p>'+
			    		'<p>（三）供应商同意零售商退货，零售商必须在15天内将商品退货给供应商，否则退款申请关闭，交易正常进行，工品汇将打款给供应商；供应商在零售商点击退货后的15天内未确认收货且未做任何操作，工品汇视为供应商已经收到零售商的退货并退款给零售商。</p>'+
			    		'<p>第三节 维权（交易争议）</p>'+
			    		'<p>第二十七条 供应商和零售商双方就交易在履行过程中产生争议，如双方无法协商或协商不能达成一致的，一方或双方可申请提交工品汇进行斡旋处理，工品汇有权决定受理或不受理相关争议，并对相关事实进行认定及对用户的违规行为进行处罚。</p>'+
			    		'<span class="ft14 weight">第四章 违规行为及处理</span>'+
			    		'<p>第一节 违规行为定义</p>'+
			    		'<p>第二十八条  违规行为是指用户违反工品汇的网站规则或其与工品汇签订的任何合同的行为。</p>'+
			    		'<p>第二节 违规行为</p>'+
			    		'<p>违禁信息发布</p>'+
			    		'<p>第二十九条 指用户发布国家法律法规或工品汇网站禁止或限制的商品信息行为。用户发布的商品信息一经认定属于禁止、限制销售商品信息，工品汇将立即删除该商品信息，同时根据情节轻重对用户予以警告、帐号限权直至帐号关闭等处罚。</p>'+
			    		'<p>违规供应产品信息发布</p>'+
			    		'<p>第三十条 指用户在工品汇网站涉嫌以下几种供应产品信息违规发布行为：使用恶意外部软件违规、标题描述违规、属性不实、类目放置错误、无货空挂、虚假价格违规等；用户发布的供应产品商品信息一经认定属于违规信息，工品汇将根据情节轻重对用户予以产品信息下架、信息删除、帐号限权等处罚。</p>'+
			    		'<p>供应产品重复信息发布</p>'+
			    		'<p>第三十一条  指用户在工品汇网站发布的供应产品信息与此前已发布上线的信息完全相同或产品重要属性、描述（包括品牌、规格型号、图片信息等）相同；用户发布的供应产品信息一经认定属于重复信息，工品汇将根据情节轻重对用户予以产品信息降权、信息删除、帐号限权等处罚。</p>'+
			    		'<p>询价单违规发布</p>'+
			    		'<p>第三十二条 指用户在工品汇网站涉嫌以下几种询价单违规发布行为：询价单内容违反工品汇运营秩序、询价产品属于禁限售产品、询价单名为询价,实为广告、重复询价等；用户发布的询价单一经认定属于违规信息，工品汇将根据情节轻重对用户予以信息删除、帐号限权等处罚。</p>'+
			    		'<p>报价单违规发布 </p>'+
			    		'<p>第三十三条 指用户在工品汇网站涉嫌以下几种报价单违规发布行为：报价单内容违反工品汇运营秩序、报价内容与询价单无关、报价单价格不实、报价单内容涉及禁限售产品信息等；用户发布的报价单一经认定属于违规信息，工品汇将根据情节轻重对用户予以信息删除、帐号限权等处罚。</p>'+
			    		'<p>知识产权侵权</p>'+
			    		'<p>第三十四条 指用户在工品汇网站发布的信息侵犯他人知识产权等权利。用户发布的信息一旦收到相关侵权投诉，应及时提交反通知及证明材料，说明产品合法性，用户应保证提供的反通知资料真实、合法、有效，若未及时提交反通知，或提交的反通知不成立，工品汇将根据情节轻重对用户予以信息删除、帐号限权直至帐号关闭等处罚。 </p>'+
			    		'<p>第三节 违规行为处理的执行 </p>'+
			    		'<p>第三十五条 用户有违规行为的，工品汇有权对用户予以违规扣分及处罚；同时每个自然月工品汇将对供应商进行综合累计考评，并视考评结果对达到考评处罚标准的用户予以相应处罚。</p>'+
			    		'<p>第四节 违规行为处理的申诉</p>'+
			    		'<p>第三十六条 对发布限制产品信息类违规及知识产权侵权类违规行为处理的申诉，被投诉人须在被投诉之日起3个工作日内提交相关证明材料。逾期未提交证明材料或提交证明材料不充分的，工品汇有权根据当时所掌握的情况进行判断与处理。</p>'+
			    		'</div>';
			    	$(this).openWin({
			    		"width":800,
			    		"height":400,
			    		"htmlCont":mHtml
			    	});
			    });
			}
		};
	})();
	
	$(function(){		
		register.init();
	});
})(jQuery,pubFuc||{});